<html>

<head>
    <meta charset="UTF-8">
    <title>Clancy Editor</title>
    <link rel="stylesheet" href="styles/header.css">
    <link rel="stylesheet" href="styles/cEditor.css">
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Roboto&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display&display=swap');
        body {
            margin: 0px;
        }
    </style>
</head>

<body>
    <div class="header">
        <div class="header-content">
            <div class="header-return">
                <i data-feather="arrow-left"></i>
                <div class="header-return-label"><a href="/">Back</a></div>
            </div>
            <div class="header-logo">
                <img draggable="false" src="ClancyEditor.png">
            </div>
        </div>
    </div>
    <div class="cEditor-wrapper">
        <div class="cEditor-container">
            <div class="cEditor">
                <div class="cEditor-content">
                    <div class="cEditor-default cEdit-title">
                        <input autocorrect="on" type="text" placeholder="Title">
                    </div>
                    <div class="cEditor-default cEdit-desc">
                        <input autocorrect="on" type="text" placeholder="Description">
                    </div>
                    <div id="blocksContainer" class="block-container"></div>
                    <div class="cEditor-add-container">
                        <div id="ModalTrigger" onclick="cEditorModalTrigger()" class="cEditor-add-modal-trigger">
                            <i data-feather="plus-circle"></i>
                        </div>
                        <div id="OptionModal" class="cEditor-add-modal">
                            <div cEditorDataType="0" class="cEditor-modal-option">
                                <div class="cEditor-modal-option-container">
                                    <i data-feather="align-left"></i>
                                    <div>Paragraph</div>
                                </div>
                            </div>
                            <div cEditorDataType="1" class="cEditor-modal-option">
                                <div class="cEditor-modal-option-container">
                                    <i data-feather="type"></i>
                                    <div>Header</div>
                                </div>
                            </div>
                            <div cEditorDataType="2" class="cEditor-modal-option">
                                <div class="cEditor-modal-option-container">
                                    <i data-feather="image"></i>
                                    <div>Image</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>feather.replace()</script>
    <script>
        // Menu
        var OptionModal = document.getElementById('OptionModal');
        var ModalTrigger = document.getElementById('ModalTrigger')

        function cEditorModalTrigger() {
            OptionModal.classList.add("modal-trigger");
        }

        document.addEventListener('click', function(event) {
            if (!(OptionModal.contains(event.target) || ModalTrigger.contains(event.target))) {
                OptionModal.classList.remove("modal-trigger");
            }
        });

      var cEditorOptions = document.getElementsByClassName("cEditor-modal-option")

      /* Cycle Options Commands with cEditorData value */
      for(let x=0;x<cEditorOptions.length; x++){
        cEditorOptions[x].addEventListener("click", cEditorCommander, false)
      }

      function cEditorCommander() {
        var command = this.getAttribute("cEditorDataType")
        switch(command) {
          case "0":
          generateBlock('paragraph')
            break;
          case "1":
          generateBlock('header')
            break;
          case "2":
          generateBlock('image')
            break  
        }
        OptionModal.classList.remove("modal-trigger");
      }

    </script>
    <script>
        
    var blocksContainer = document.querySelector("#blocksContainer")
    blocksContainer.addEventListener("keydown", blockScanner, false)

    function blockScanner(block) {
        // this = container, block.target = selected block

        // Delete block
        if(event.keyCode == 8 && emptyBlock(block.target)) {
            block.preventDefault()

            let deletedBlockIndex = getBlockIndex(this.children, block.target)
            let blocksLength = this.children.length

            block.target.remove()

            if(blocksLength > 1) {
                if(deletedBlockIndex >= 1) {
                    //this.children[deletedBlockIndex-1].focus()
                    setCaretPosition(this.children[deletedBlockIndex-1])
                } else {
                    //this.children[0].focus()
                    setCaretPosition(this.children[0])
                }
            }
        }

        // Traverse Blocks with 


    }

    function setCaretPosition(block) {
        var range = document.createRange();
        var sel = window.getSelection();
        var blockNodes = block.childNodes
        

        if(blockNodes.length != 0) {
            range.setStart(blockNodes[blockNodes.length-1], 1);
            range.collapse(true);
            sel.removeAllRanges();
            sel.addRange(range);
        }
        block.focus()
    }

    function emptyBlock(block) {
        let blockData = block.innerHTML
        return blockData == "" || blockData == "<br>"
    }

    function getBlockIndex(blocks, block) {
        for (var i = 0; i < blocks.length; i++) {
            if (blocks[i] === block) {
                return i;
            }
        }
        return -1;
    }
    
    function generateBlock(command) {
        var div = document.createElement('div');
        div.setAttribute('contenteditable', true)
        div.setAttribute('class','cEditor-block')
        div.setAttribute('blockType',command)
        div.innerHTML = ""
        document.getElementById('blocksContainer').appendChild(div).focus()
        blockScanner()
      }
    </script>
</body>

</html>